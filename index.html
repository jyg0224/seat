<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>랜덤 자리바꾸기</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCFE25bdLM9PN8t7IPDzeu9w8VVa7TykLU",
      authDomain: "randomseat-fe53e.firebaseapp.com",
      databaseURL: "https://randomseat-fe53e-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "randomseat-fe53e",
      storageBucket: "randomseat-fe53e.appspot.com",
      messagingSenderId: "1083859443221",
      appId: "1:1083859443221:web:2a6c07241e344da2d9b81c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let fixedSeats = {};
    let imageMap = {};
    let names = [];

    window.onload = () => {
      document.getElementById('saveBtn').addEventListener('click', saveToFirebase);
      document.getElementById('loadBtn').addEventListener('click', loadFromFirebase);
      document.getElementById('assignBtn').addEventListener('click', assignSeats);
      document.getElementById('imgUpload').addEventListener('change', handleImageUpload);
      document.getElementById('pdfBtn').addEventListener('click', savePdf);
    }

    function generateCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      return Array.from({ length: 6 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
    }

    async function saveToFirebase() {
      const code = generateCode();
      const data = {
        nameInput: document.getElementById('nameInput').value,
        row: document.getElementById('rowCount').value,
        col: document.getElementById('colCount').value,
        dir: document.getElementById('direction').value,
        fixed: fixedSeats,
        images: imageMap
      };
      await set(ref(db, 'seats/' + code), data);
      alert(`저장되었습니다. 인증코드: ${code}`);
    }

    async function loadFromFirebase() {
      const code = prompt('인증코드를 입력하세요');
      const snapshot = await get(child(ref(db), 'seats/' + code));
      if (snapshot.exists()) {
        const data = snapshot.val();
        document.getElementById('nameInput').value = data.nameInput;
        document.getElementById('rowCount').value = data.row;
        document.getElementById('colCount').value = data.col;
        document.getElementById('direction').value = data.dir;
        fixedSeats = data.fixed || {};
        imageMap = data.images || {};
        assignSeats();
      } else {
        alert('데이터가 존재하지 않습니다.');
      }
    }

    function handleImageUpload(e) {
      const files = e.target.files;
      for (const file of files) {
        const name = file.name.split('.')[0];
        const reader = new FileReader();
        reader.onload = function(evt) {
          imageMap[name] = evt.target.result;
        }
        reader.readAsDataURL(file);
      }
    }

    function savePdf() {
      const includeImage = document.getElementById('includeImage').checked;
      const seatArea = document.getElementById('seatGrid').cloneNode(true);
      const seats = seatArea.querySelectorAll('.seat');

      if (includeImage) {
        seats.forEach(seat => {
          const name = seat.textContent.trim();
          if (imageMap[name]) {
            const img = document.createElement('img');
            img.src = imageMap[name];
            img.style.width = '30px';
            img.style.height = '30px';
            img.style.border = '1px solid #666';
            img.style.position = 'absolute';
            img.style.bottom = '2px';
            img.style.right = '2px';
            seat.style.position = 'relative';
            seat.appendChild(img);
          }
        });
      }

      const opt = {
        margin: 1,
        filename: '자리배치.pdf',
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };
      html2pdf().from(seatArea).set(opt).save();
    }

    function assignSeats() {
      names = document.getElementById('nameInput').value.split(/[\n,]/).map(n => n.trim()).filter(n => n);
      const rows = parseInt(document.getElementById('rowCount').value);
      const cols = parseInt(document.getElementById('colCount').value);
      const direction = document.getElementById('direction').value;

      const grid = Array.from({ length: rows }, () => Array(cols).fill(null));
      const assigned = new Set(Object.values(fixedSeats));
      const remain = names.filter(n => !assigned.has(n));
      shuffleArray(remain);

      for (let key in fixedSeats) {
        const [r, c] = key.split('-').map(Number);
        grid[r][c] = fixedSeats[key];
      }

      for (let i = rows - 1; i >= 0; i--) {
        const colRange = direction === 'right' ? [...Array(cols).keys()].reverse() : [...Array(cols).keys()];
        for (let j of colRange) {
          const key = `${i}-${j}`;
          if (!fixedSeats[key] && remain.length > 0) {
            grid[i][j] = remain.pop();
          }
        }
      }
      renderGrid(grid);
    }

    function renderGrid(grid) {
      const seatGrid = document.getElementById('seatGrid');
      seatGrid.innerHTML = '';
